<div class="flex flex-col gap-4">
  <div class="flex items-center justify-between">
    <a routerLink="/agenda"
       class="text-sm font-medium text-stone-600 dark:text-stone-400 hover:text-stone-900 dark:hover:text-stone-100 transition-colors">
      ← Volver a la agenda
    </a>
  </div>

  @if (loading()) {
    <div class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-8 text-center text-stone-500 dark:text-stone-400">
      <p>Cargando…</p>
    </div>
  } @else if (notFound() || !servicio()) {
    <div class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-8 text-center text-stone-500 dark:text-stone-400">
      <p>No se encontró el servicio.</p>
      <a routerLink="/agenda" class="mt-3 inline-block text-sm font-medium text-amber-600 dark:text-amber-400 hover:underline">
        Volver a la agenda
      </a>
    </div>
  } @else {
    <header class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-4 shadow-sm border-l-4 border-l-amber-500 dark:border-l-amber-400">
      <h1 class="text-xl font-bold text-stone-800 dark:text-stone-100">
        {{ formatDate(servicio()!.fecha) }}
      </h1>
      @if (servicio()!.nombre) {
        <p class="mt-1 text-stone-600 dark:text-stone-300">{{ servicio()!.nombre }}</p>
      }
      <p class="mt-2 text-sm text-stone-500 dark:text-stone-400">
        Asigna una persona por instrumento y hasta 5 voces. Solo se muestran quienes están disponibles (sin novedad ese día).
      </p>
    </header>

    <section class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 shadow-sm overflow-hidden">
      <ul class="divide-y divide-stone-200 dark:divide-stone-600">
        @for (slot of slots(); track slot.label + $index) {
          <li class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 p-4">
            <span class="font-medium text-stone-700 dark:text-stone-200 min-w-[6rem]">{{ slot.label }}</span>
            <div class="flex flex-wrap items-center gap-2">
              @if (slot.asignacion) {
                <span class="text-stone-900 dark:text-stone-100">{{ slot.asignacion.nombreCompleto }}</span>
                <button type="button"
                        (click)="remove($index)"
                        [disabled]="updating() !== null"
                        class="text-sm text-stone-500 dark:text-stone-400 hover:text-red-600 dark:hover:text-red-400 disabled:opacity-50">
                  Quitar
                </button>
              } @else {
                <span class="text-stone-400 dark:text-stone-500 text-sm">Sin asignar</span>
                @if (isSelecting($index)) {
                  <div class="flex flex-wrap items-center gap-2 mt-1 sm:mt-0">
                    @if (loadingDisponibles()) {
                      <span class="text-sm text-stone-500 dark:text-stone-400">Cargando…</span>
                    } @else if (disponibles().length === 0) {
                      <span class="text-sm text-stone-500 dark:text-stone-400">Nadie disponible con este rol</span>
                      <button type="button"
                              (click)="closeSelector()"
                              class="text-sm font-medium text-stone-600 dark:text-stone-400 hover:underline">
                        Cerrar
                      </button>
                    } @else {
                      @for (m of disponibles(); track m.id) {
                        <button type="button"
                                (click)="assign($index, m)"
                                [disabled]="updating() !== null"
                                class="rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-3 py-1.5 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-amber-500 hover:text-white hover:border-amber-500 dark:hover:bg-amber-500 dark:hover:border-amber-500 transition-colors disabled:opacity-50">
                          {{ memberDisplay(m) }}
                        </button>
                      }
                      <button type="button"
                              (click)="closeSelector()"
                              class="text-sm font-medium text-stone-500 dark:text-stone-400 hover:underline">
                        Cancelar
                      </button>
                    }
                  </div>
                } @else {
                  <button type="button"
                          (click)="openSelector($index)"
                          class="rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-3 py-1.5 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors">
                    Asignar
                  </button>
                }
              }
            </div>
          </li>
        }
      </ul>
    </section>
  }
</div>
