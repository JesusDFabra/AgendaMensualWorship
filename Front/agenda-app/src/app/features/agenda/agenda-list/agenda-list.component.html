<div class="flex flex-col gap-4">
  <div class="flex items-center justify-between">
    <a routerLink="/"
       class="text-sm font-medium text-stone-600 dark:text-stone-400 hover:text-stone-900 dark:hover:text-stone-100 transition-colors">
      ‚Üê Volver al inicio
    </a>
  </div>

  <header class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-4 shadow-sm">
    <h1 class="text-xl font-bold text-stone-800 dark:text-stone-100">Agenda de servicios</h1>
    <p class="mt-1 text-sm text-stone-500 dark:text-stone-400">
      Elige un d√≠a del calendario que tenga servicio para asignar al equipo de alabanza.
    </p>
  </header>

  @if (loading()) {
    <div class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-8 text-center text-stone-500 dark:text-stone-400">
      <p>Cargando calendario‚Ä¶</p>
    </div>
  } @else {
    <section class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-4 shadow-sm">
      <div class="grid grid-cols-3 items-center gap-4 mb-4">
        <div class="flex justify-start">
          <button type="button"
                  (click)="prevMonth()"
                  class="rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-3 py-2 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors">
            ‚Üê Anterior
          </button>
        </div>
        <a [routerLink]="['/agenda', 'mes', currentYear(), currentMonth()]"
             class="inline-flex items-center justify-center gap-2 rounded-xl border-2 border-dashed border-stone-300 dark:border-stone-600 bg-amber-50/80 dark:bg-amber-900/20 px-4 py-2.5 text-lg font-semibold text-stone-800 dark:text-stone-100 text-center hover:border-amber-400 hover:bg-amber-100 dark:hover:border-amber-500 dark:hover:bg-amber-900/40 hover:text-amber-700 dark:hover:text-amber-300 transition-all cursor-pointer">
          <span aria-hidden="true">üìÖ</span>
          {{ monthLabel() }}
          <span class="text-sm font-medium text-stone-500 dark:text-stone-400"></span>
        </a>
        <div class="flex justify-end">
          <button type="button"
                  (click)="nextMonth()"
                  class="rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-3 py-2 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors">
            Siguiente ‚Üí
          </button>
        </div>
      </div>

      <div class="grid grid-cols-7 gap-1 sm:gap-2">
        @for (w of weekDays; track w) {
          <div class="text-center text-xs font-medium text-stone-500 dark:text-stone-400 py-1">
            {{ w }}
          </div>
        }
        @for (cell of calendarGrid(); track (cell.dateStr ?? 'e' + $index)) {
          @if (cell.day === null) {
            <div class="aspect-[2/1] rounded-lg bg-stone-50/50 dark:bg-stone-800/30"
                 aria-hidden="true"></div>
          } @else if (cell.servicio) {
            <button type="button"
                    (click)="openAssignmentModal(cell.servicio!)"
                    [attr.aria-label]="'Asignar servicio del d√≠a ' + cell.day"
                    class="aspect-[2/1] rounded-lg text-sm font-medium min-w-0 flex items-center justify-center
                           bg-amber-500 dark:bg-amber-500 text-white hover:bg-amber-600 dark:hover:bg-amber-600
                           shadow-sm transition-all hover:shadow-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 dark:focus:ring-offset-stone-900">
              {{ cell.day }}
            </button>
          } @else {
            <div class="aspect-[2/1] rounded-lg bg-stone-100 dark:bg-stone-700/50 text-stone-400 dark:text-stone-500 text-sm flex items-center justify-center border border-stone-200 dark:border-stone-600"
                 aria-hidden="true">
              {{ cell.day }}
            </div>
          }
        }
      </div>

      <p class="mt-4 text-xs text-stone-500 dark:text-stone-400">
        D√≠as en naranja = hay servicio (clic para asignar los miembros de ese d√≠a). Clic en el <strong>mes</strong> para ver y programar todo el mes.
      </p>
    </section>
  }

  <!-- Modal de asignaci√≥n -->
  @if (selectedServicio()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4"
         role="dialog"
         aria-modal="true"
         aria-labelledby="modal-asignacion-title">
      <div class="fixed inset-0 bg-black/50"
           (click)="closeAssignmentModal()"></div>
      <div class="relative z-10 w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-2xl border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-900 shadow-xl">
        <div class="sticky top-0 z-10 border-b border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 rounded-t-2xl">
          <div class="flex items-center justify-between gap-4 p-4">
            <h2 id="modal-asignacion-title" class="text-lg text-stone-800 dark:text-stone-100">
              <span class="font-medium text-stone-500 dark:text-stone-400">Asignar miembros al servicio ‚Äî </span>
              <span class="font-bold text-stone-900 dark:text-stone-50">{{ formatDate(selectedServicio()!.fecha) }}</span>
            </h2>
            <button type="button"
                    (click)="closeAssignmentModal()"
                    class="rounded-lg p-2 text-stone-500 dark:text-stone-400 hover:bg-stone-200 dark:hover:bg-stone-700 transition-colors"
                    aria-label="Cerrar">
              <span class="text-xl leading-none" aria-hidden="true">√ó</span>
            </button>
          </div>
          <nav class="flex gap-2 px-4 py-3 bg-stone-100 dark:bg-stone-700/50 border-t border-stone-200 dark:border-stone-600"
               aria-label="Secciones del servicio">
            <button type="button"
                    (click)="setModalTab('miembros')"
                    class="px-4 py-2.5 text-sm font-semibold rounded-lg transition-colors border-2 min-w-[7rem]"
                    [class.bg-amber-500]="modalTab() === 'miembros'"
                    [class.text-white]="modalTab() === 'miembros'"
                    [class.border-amber-500]="modalTab() === 'miembros'"
                    [class.bg-white]="modalTab() !== 'miembros'"
                    [class.dark:bg-stone-700]="modalTab() !== 'miembros'"
                    [class.text-stone-700]="modalTab() !== 'miembros'"
                    [class.dark:text-stone-200]="modalTab() !== 'miembros'"
                    [class.border-stone-300]="modalTab() !== 'miembros'"
                    [class.dark:border-stone-600]="modalTab() !== 'miembros'">
              Miembros
            </button>
            <button type="button"
                    (click)="setModalTab('canciones')"
                    class="px-4 py-2.5 text-sm font-semibold rounded-lg transition-colors border-2 min-w-[7rem]"
                    [class.bg-amber-500]="modalTab() === 'canciones'"
                    [class.text-white]="modalTab() === 'canciones'"
                    [class.border-amber-500]="modalTab() === 'canciones'"
                    [class.bg-white]="modalTab() !== 'canciones'"
                    [class.dark:bg-stone-700]="modalTab() !== 'canciones'"
                    [class.text-stone-700]="modalTab() !== 'canciones'"
                    [class.dark:text-stone-200]="modalTab() !== 'canciones'"
                    [class.border-stone-300]="modalTab() !== 'canciones'"
                    [class.dark:border-stone-600]="modalTab() !== 'canciones'">
              Canciones
            </button>
          </nav>
        </div>
        <div class="p-4">
          <app-service-assignment-form
            [servicioId]="selectedServicio()!.id"
            [servicio]="selectedServicio()!"
            [showHeader]="false"
            [activeTab]="modalTab()"
            (tabChange)="setModalTab($event)" />
        </div>
        <div class="sticky bottom-0 flex justify-end gap-2 p-4 border-t border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 rounded-b-2xl">
          <button type="button"
                  (click)="closeAssignmentModal()"
                  class="rounded-xl bg-amber-500 px-6 py-2.5 text-sm font-semibold text-white hover:bg-amber-600 dark:bg-amber-500 dark:hover:bg-amber-600 transition-colors">
            Aceptar
          </button>
        </div>
      </div>
    </div>
  }
</div>
