<div class="flex flex-col gap-4">
  <div class="flex justify-start">
    <a routerLink="/miembros"
       class="text-sm font-medium text-stone-600 dark:text-stone-400 hover:text-stone-900 dark:hover:text-stone-100 transition-colors">
      ← Volver al listado
    </a>
  </div>

  @if (loading) {
    <div class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-8 text-center text-stone-500 dark:text-stone-400">
      <p>Cargando…</p>
    </div>
  } @else if (notFound || !member) {
    <div class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-8 text-center text-stone-500 dark:text-stone-400">
      <p>No se encontró el miembro.</p>
      <a routerLink="/miembros" class="mt-3 inline-block text-sm font-medium text-amber-600 dark:text-amber-400 hover:underline">
        Volver al listado
      </a>
    </div>
  } @else if (editUnlocked) {
    <app-member-form [memberId]="member.id"
                     (saved)="onMemberSaved()"
                     (cancelled)="editUnlocked = false"></app-member-form>
  } @else {
    <!-- Contenedor: perfil a la izquierda, Próximos servicios a la derecha en pantallas grandes -->
    <div class="grid grid-cols-1 md:grid-cols-[35%_1fr] gap-4 md:gap-6 md:items-start">
      <!-- Columna izquierda: cabecera y datos en una sola sección -->
      <div class="min-w-0">
        <section class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-6 shadow-sm border-l-4"
                [ngClass]="member.activo ? 'border-l-amber-500 dark:border-l-amber-400' : 'border-l-stone-400 dark:border-l-stone-500'">
          <!-- Cabecera: nombre, alias, estado, rol -->
          <div class="flex flex-wrap items-start justify-between gap-4">
            <div class="min-w-0">
              <h1 class="text-2xl sm:text-3xl font-bold text-stone-900 dark:text-stone-50 tracking-tight">
                {{ member.nombre }} {{ member.apellido }}
              </h1>
              @if (member.alias) {
                <p class="mt-1 text-lg text-stone-600 dark:text-stone-300 font-medium">«{{ member.alias }}»</p>
              }
              <div class="mt-3 flex items-center gap-2">
                <span [ngClass]="{
                  'inline-flex items-center rounded-full px-3 py-1 text-sm font-medium': true,
                  'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300': member.activo,
                  'bg-stone-100 text-stone-600 dark:bg-stone-700 dark:text-stone-400': !member.activo
                }">
                  {{ member.activo ? 'Activo' : 'Inactivo' }}
                </span>
                @if (member.rol?.nombre) {
                  <span class="text-sm text-stone-500 dark:text-stone-400">· {{ member.rol?.nombre }}</span>
                }
              </div>
            </div>
            @if (!editUnlocked) {
              <button type="button"
                      (click)="openEditModal()"
                      class="shrink-0 rounded-lg border border-amber-500 dark:border-amber-400 bg-amber-50 dark:bg-stone-700 px-4 py-2 text-sm font-medium text-amber-800 dark:text-amber-200 hover:bg-amber-100 dark:hover:bg-stone-600 transition-colors">
                Editar
              </button>
            }
          </div>

          <!-- Datos de la persona (solo icono + valores, sin etiquetas; énfasis bajo) -->
          <div class="mt-6">
            <ul class="flex flex-col gap-2 text-sm text-stone-600 dark:text-stone-400">
              <li class="flex items-center gap-2">
                <i class="fi fi-rr-calendar text-stone-400 dark:text-stone-500 shrink-0" aria-hidden="true"></i>
                <span>{{ formatDate(member.fecNacimiento) }}</span>
              </li>
              @if (member.correo) {
                <li class="flex items-center gap-2">
                  <i class="fi fi-rr-envelope text-stone-400 dark:text-stone-500 shrink-0" aria-hidden="true"></i>
                  <a [href]="'mailto:' + member.correo" class="break-all hover:text-amber-600 dark:hover:text-amber-400">{{ member.correo }}</a>
                </li>
              }
              @if (member.celular) {
                <li class="flex items-center gap-2">
                  <i class="fi fi-rr-phone-call text-stone-400 dark:text-stone-500 shrink-0" aria-hidden="true"></i>
                  <a [href]="'tel:' + member.celular" class="hover:text-amber-600 dark:hover:text-amber-400">{{ member.celular }}</a>
                </li>
              }
            </ul>
          </div>
        </section>
      </div>

      <!-- Columna derecha: Próximos servicios (solo en lg a la derecha) -->
      <section class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-4 shadow-sm lg:sticky lg:top-4">
        <h2 class="flex items-center gap-2 text-sm font-semibold uppercase tracking-wider text-stone-500 dark:text-stone-400 mb-3">
          <i class="fi fi-rr-clipboard-list text-base" aria-hidden="true"></i>
          Próximos servicios
        </h2>
        @if (loadingProximosServicios) {
          <p class="text-sm text-stone-500 dark:text-stone-400">Cargando…</p>
        } @else if (proximosServicios.length === 0) {
          <p class="text-sm text-stone-500 dark:text-stone-400">No tiene servicios asignados a partir de hoy.</p>
        } @else {
          <ul class="space-y-2">
            @for (s of proximosServicios; track s.servicioId) {
              <li>
                <button type="button"
                        (click)="openServiceView(s.servicioId)"
                        class="w-full flex flex-wrap items-center gap-2 rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50/50 dark:bg-stone-700/30 px-3 py-2 text-sm font-medium text-stone-800 dark:text-stone-200 hover:bg-amber-50 hover:border-amber-200 dark:hover:bg-amber-900/20 dark:hover:border-amber-600 transition-colors text-left">
                  <span>{{ formatDateLong(s.fecha) }}</span>
                  @if (s.rolNombre) {
                    <span class="text-stone-500 dark:text-stone-400">· {{ s.rolNombre }}</span>
                  }
                  <span class="ml-auto text-amber-600 dark:text-amber-400 text-xs">Ver servicio →</span>
                </button>
              </li>
            }
          </ul>
        }
      </section>
    </div>

    <!-- Modal ver detalle del servicio (solo lectura) -->
    @if (selectedServicioIdForView !== null) {
      <app-service-view-modal [servicioId]="selectedServicioIdForView"
                              (closed)="selectedServicioIdForView = null" />
    }

    <!-- Modal verificar documento para editar -->
    @if (showEditModal) {
      <div class="fixed inset-0 z-50 flex items-center justify-center p-4"
           role="dialog"
           aria-modal="true"
           aria-labelledby="edit-modal-title">
        <div class="fixed inset-0 bg-black/50" (click)="closeEditModal()"></div>
        <div class="relative z-10 w-full max-w-sm rounded-2xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-6 shadow-xl">
          <h3 id="edit-modal-title" class="text-lg font-semibold text-stone-800 dark:text-stone-100 mb-2">Editar datos de «{{ member.nombre }} {{ member.apellido }}»</h3>
          <p class="text-sm text-stone-600 dark:text-stone-400 mb-4">
            Ingresa el número de documento para poder editar cualquier campo.
          </p>
          <label for="edit-doc" class="sr-only">Numero de documento</label>
          <input id="edit-doc"
                 type="password"
                 autocomplete="off"
                 [(ngModel)]="editDocumento"
                 name="editDocumento"
                 placeholder="Número de documento"
                 class="w-full rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-4 py-2.5 text-stone-800 dark:text-stone-200 placeholder:text-stone-400 focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 mb-3"
                 (keydown.enter)="confirmEditDocumento()">
          @if (editDocError) {
            <p class="text-sm text-red-600 dark:text-red-400 mb-3">{{ editDocError }}</p>
          }
          <div class="flex gap-3 justify-end">
            <button type="button"
                    (click)="closeEditModal()"
                    class="rounded-lg border border-stone-200 dark:border-stone-600 px-4 py-2 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700">
              Cancelar
            </button>
            <button type="button"
                    (click)="confirmEditDocumento()"
                    class="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700 disabled:opacity-50">
              Continuar
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Novedades: días en que no puede estar -->
    <section class="rounded-xl border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-800/50 p-6">
      <h2 class="text-lg font-semibold text-stone-800 dark:text-stone-100 mb-2">Novedades y disponibilidad</h2>
      <p class="text-sm text-stone-500 dark:text-stone-400 mb-4">
        Indica en qué días con servicio no podrás estar. Debes ingresar tu documento para modificar.
      </p>
      @if (!novedadCalendarVisible) {
        <button type="button"
                (click)="openNovedadModal()"
                class="rounded-lg border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-700 px-4 py-2 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-600 transition-colors">
          Agregar novedad o día sin disponibilidad
        </button>
      } @else {
        <div class="flex items-center justify-between mb-3">
          <p class="text-base text-stone-600 dark:text-stone-400">
            <span class="inline-block w-3 h-3 rounded bg-green-500 align-middle mr-1"></span> Disponible &nbsp;
            <span class="inline-block w-3 h-3 rounded bg-stone-400 dark:bg-stone-500 align-middle mr-1"></span> No disponible. Clic en un día para cambiar.
          </p>
          <button type="button"
                  (click)="closeNovedadCalendar()"
                  class="rounded-lg border border-stone-200 dark:border-stone-600 px-3 py-1.5 text-base font-medium text-stone-600 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-700">
            Ocultar calendario
          </button>
        </div>
        @if (loadingNovedades) {
          <p class="text-base text-stone-500 dark:text-stone-400 py-4 mt-4">Cargando días con servicio…</p>
        } @else if (servicios.length === 0) {
          <p class="text-base text-stone-500 dark:text-stone-400 py-4 mt-4">No hay días con servicio en los próximos 3 meses.</p>
        } @else {
          <div class="mt-7 pt-6 border-t border-stone-200 dark:border-stone-600 text-base">
            <div class="grid grid-cols-3 items-center gap-2 mb-3">
              <button type="button"
                      (click)="novedadPrevMonth()"
                      class="justify-self-start rounded border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-2.5 py-1 text-base font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 w-fit whitespace-nowrap">
                ← Anterior
              </button>
              <span class="text-center text-lg font-semibold text-stone-800 dark:text-stone-100">{{ novedadMonthLabel() }}</span>
              <button type="button"
                      (click)="novedadNextMonth()"
                      class="justify-self-end rounded border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-2.5 py-1 text-base font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 w-fit whitespace-nowrap">
                Siguiente →
              </button>
            </div>
            <div class="grid grid-cols-7 gap-0.5 text-center text-sm font-medium text-stone-500 dark:text-stone-400 mb-1">
            @for (w of weekDays; track w) {
              <span>{{ w }}</span>
            }
          </div>
          <div class="grid grid-cols-7 gap-1">
            @for (cell of novedadCalendarGrid(); track (cell.dateStr ?? 'e' + $index)) {
              @if (cell.servicio) {
                <button type="button"
                        (click)="toggleNovedad(cell.servicio)"
                        [disabled]="updatingNovedadServicioId === cell.servicio.id"
                        [attr.aria-pressed]="hasNovedadForServicio(cell.servicio.id)"
                        [attr.title]="hasNovedadForServicio(cell.servicio.id) ? 'Clic para quitar novedad' : 'Clic para marcar no disponible'"
                        class="aspect-[2/1] min-w-0 rounded-lg text-base font-medium transition-colors disabled:opacity-50
                              {{ hasNovedadForServicio(cell.servicio.id)
                                 ? 'bg-stone-400 dark:bg-stone-500 text-white hover:bg-stone-500 dark:hover:bg-stone-600'
                                 : 'bg-green-500 dark:bg-green-500 text-white hover:bg-green-600 dark:hover:bg-green-600' }}">
                  {{ cell.day }}
                </button>
              } @else if (cell.day !== null) {
                <div class="aspect-[2/1] rounded-lg bg-stone-100/50 dark:bg-stone-800/30 text-stone-400 dark:text-stone-500 text-base flex items-center justify-center" aria-hidden="true">
                  {{ cell.day }}
                </div>
              } @else {
                <div class="aspect-[2/1] rounded-lg bg-stone-50/50 dark:bg-stone-800/20" aria-hidden="true"></div>
              }
            }
          </div>
          </div>
        }
      }
    </section>

    <!-- Modal solo para verificar documento antes de mostrar el calendario -->
    @if (showNovedadModal) {
      <div class="fixed inset-0 z-50 flex items-center justify-center p-4"
           role="dialog"
           aria-modal="true"
           aria-labelledby="novedad-modal-title">
        <div class="fixed inset-0 bg-black/50" (click)="closeNovedadModal()"></div>
        <div class="relative z-10 w-full max-w-sm rounded-2xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-6 shadow-xl">
          <h3 id="novedad-modal-title" class="text-lg font-semibold text-stone-800 dark:text-stone-100 mb-2">Verificar identidad</h3>
          <p class="text-sm text-stone-600 dark:text-stone-400 mb-4">
            Para gestionar tus días sin disponibilidad, ingresa tu número de documento.
          </p>
          <label for="novedad-doc" class="sr-only">Número de documento</label>
          <input id="novedad-doc"
                 type="password"
                 autocomplete="off"
                 [(ngModel)]="novedadDocumento"
                 name="novedadDocumento"
                 placeholder="Número de documento"
                 class="w-full rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-4 py-2.5 text-stone-800 dark:text-stone-200 placeholder:text-stone-400 focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 mb-3"
                 (keydown.enter)="confirmNovedadDocumento()">
          @if (novedadDocError) {
            <p class="text-sm text-red-600 dark:text-red-400 mb-3">{{ novedadDocError }}</p>
          }
          <div class="flex gap-3 justify-end">
            <button type="button"
                    (click)="closeNovedadModal()"
                    class="rounded-lg border border-stone-200 dark:border-stone-600 px-4 py-2 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700">
              Cancelar
            </button>
            <button type="button"
                    (click)="confirmNovedadDocumento()"
                    [disabled]="loadingNovedades"
                    class="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700 disabled:opacity-50">
              {{ loadingNovedades ? 'Cargando…' : 'Continuar' }}
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Modal motivo de la ausencia (deshabilitado: cambiar false por showMotivoForNovedad para reactivar) -->
    @if (false) {
      <div class="fixed inset-0 z-[60] flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="motivo-title">
        <div class="fixed inset-0 bg-black/50" (click)="closeMotivoModal()"></div>
        <div class="relative z-10 w-full max-w-md rounded-2xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-6 shadow-xl">
          <h4 id="motivo-title" class="text-lg font-semibold text-stone-800 dark:text-stone-100 mb-2">Motivo de la novedad (opcional)</h4>
          <p class="text-sm text-stone-600 dark:text-stone-400 mb-3">Indica por qué no podrás ese día, si lo deseas.</p>
          <label for="motivo-text" class="sr-only">Motivo</label>
          <textarea id="motivo-text"
                    [(ngModel)]="motivoTexto"
                    name="motivoTexto"
                    rows="3"
                    placeholder="Ej: Viaje, enfermedad, otro compromiso…"
                    class="w-full rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-4 py-2.5 text-stone-800 dark:text-stone-200 placeholder:text-stone-400 resize-none mb-4 focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500"></textarea>
          <div class="flex gap-3 justify-end">
            <button type="button"
                    (click)="closeMotivoModal()"
                    [disabled]="savingMotivo"
                    class="rounded-lg border border-stone-200 dark:border-stone-600 px-4 py-2 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 disabled:opacity-50">
              Omitir
            </button>
            <button type="button"
                    (click)="saveMotivo()"
                    [disabled]="savingMotivo"
                    class="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700 disabled:opacity-50">
              {{ savingMotivo ? 'Guardando…' : 'Guardar' }}
            </button>
          </div>
        </div>
      </div>
    }
  }
</div>
