<div class="flex flex-col gap-4">
  <div class="flex items-center justify-between">
    <a routerLink="/miembros"
       class="text-sm font-medium text-stone-600 dark:text-stone-400 hover:text-stone-900 dark:hover:text-stone-100 transition-colors">
      ← Volver al listado
    </a>
  </div>

  @if (loading) {
    <div class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-8 text-center text-stone-500 dark:text-stone-400">
      <p>Cargando…</p>
    </div>
  } @else if (notFound || !member) {
    <div class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-8 text-center text-stone-500 dark:text-stone-400">
      <p>No se encontró el miembro.</p>
      <a routerLink="/miembros" class="mt-3 inline-block text-sm font-medium text-amber-600 dark:text-amber-400 hover:underline">
        Volver al listado
      </a>
    </div>
  } @else {
    <!-- Cabecera: nombre de la persona -->
    <header class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-6 shadow-sm border-l-4 border-l-amber-500 dark:border-l-amber-400">
      <h1 class="text-2xl sm:text-3xl font-bold text-stone-900 dark:text-stone-50 tracking-tight">
        {{ member.nombre }} {{ member.apellido }}
      </h1>
      @if (member.alias) {
        <p class="mt-1 text-lg text-stone-600 dark:text-stone-300 font-medium">«{{ member.alias }}»</p>
      }
      <div class="mt-3 flex items-center gap-2">
        <span [ngClass]="{
          'inline-flex items-center rounded-full px-3 py-1 text-sm font-medium': true,
          'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300': member.activo,
          'bg-stone-100 text-stone-600 dark:bg-stone-700 dark:text-stone-400': !member.activo
        }">
          {{ member.activo ? 'Activo' : 'Inactivo' }}
        </span>
        @if (member.rol?.nombre) {
          <span class="text-sm text-stone-500 dark:text-stone-400">· {{ member.rol?.nombre }}</span>
        }
      </div>
    </header>

    <!-- Datos básicos -->
    <section class="rounded-xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-4 shadow-sm">
      <h2 class="text-sm font-semibold uppercase tracking-wider text-stone-500 dark:text-stone-400 mb-2">Datos de la persona</h2>
      <dl class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <dt class="text-sm font-medium uppercase tracking-wider text-stone-500 dark:text-stone-400">Nombre completo</dt>
          <dd class="mt-0.5 text-lg font-medium text-stone-900 dark:text-stone-100">{{ member.nombre }} {{ member.apellido }}</dd>
        </div>
        @if (member.alias) {
          <div>
            <dt class="text-sm font-medium uppercase tracking-wider text-stone-500 dark:text-stone-400">Alias</dt>
            <dd class="mt-0.5 text-lg font-medium text-stone-900 dark:text-stone-100">{{ member.alias }}</dd>
          </div>
        }
        <div>
          <dt class="text-sm font-medium uppercase tracking-wider text-stone-500 dark:text-stone-400">Fecha de nacimiento</dt>
          <dd class="mt-0.5 text-lg font-medium text-stone-900 dark:text-stone-100">{{ formatDate(member.fecNacimiento) }}</dd>
        </div>
        <div>
          <dt class="text-sm font-medium uppercase tracking-wider text-stone-500 dark:text-stone-400">Sexo</dt>
          <dd class="mt-0.5 text-lg font-medium text-stone-900 dark:text-stone-100">{{ member.sexo?.descripcion ?? '—' }}</dd>
        </div>
        <div>
          <dt class="text-sm font-medium uppercase tracking-wider text-stone-500 dark:text-stone-400">Rol</dt>
          <dd class="mt-0.5 text-lg font-medium text-stone-900 dark:text-stone-100">{{ member.rol?.nombre ?? '—' }}</dd>
        </div>
        <div class="sm:col-span-3">
          <dt class="text-sm font-medium uppercase tracking-wider text-stone-500 dark:text-stone-400 mb-1">Estado</dt>
          <dd class="mt-0.5 flex items-center gap-2">
            <button type="button"
                    (click)="onToggleActivoClick()"
                    [disabled]="updatingActivo"
                    [class.ring-2]="member.activo"
                    [class.ring-green-500]="member.activo"
                    [class.dark:ring-green-400]="member.activo"
                    class="shrink-0 flex items-center gap-2 rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-3 py-2 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors disabled:opacity-50">
              <span class="relative inline-flex h-5 w-9 rounded-full transition-colors"
                    [class.bg-green-500]="member.activo"
                    [class.dark:bg-green-400]="member.activo"
                    [class.bg-stone-300]="!member.activo"
                    [class.dark:bg-stone-600]="!member.activo">
                <span class="inline-block h-4 w-4 mt-0.5 ml-0.5 rounded-full bg-white shadow transition-transform"
                      [class.translate-x-5]="member.activo"
                      [class.translate-x-0]="!member.activo"></span>
              </span>
              {{ member.activo ? 'Activo' : 'Inactivo' }}
            </button>
            @if (updatingActivo) {
              <span class="text-xs text-stone-500 dark:text-stone-400">Guardando…</span>
            }
          </dd>
        </div>
        @if (member.correo) {
          <div class="sm:col-span-3">
            <dt class="text-sm font-medium uppercase tracking-wider text-stone-500 dark:text-stone-400">Correo</dt>
            <dd class="mt-0.5 text-lg font-medium text-stone-900 dark:text-stone-100">{{ member.correo }}</dd>
          </div>
        }
        @if (member.celular) {
          <div>
            <dt class="text-sm font-medium uppercase tracking-wider text-stone-500 dark:text-stone-400">Celular</dt>
            <dd class="mt-0.5 text-lg font-medium text-stone-900 dark:text-stone-100">{{ member.celular }}</dd>
          </div>
        }
      </dl>
    </section>

    <!-- Modal confirmar cambio de estado con documento -->
    @if (showConfirmActivo) {
      <div class="fixed inset-0 z-50 flex items-center justify-center p-4"
           role="dialog"
           aria-modal="true"
           aria-labelledby="confirm-activo-title">
        <div class="fixed inset-0 bg-black/50"
             (click)="closeConfirmActivo()"></div>
        <div class="relative z-10 w-full max-w-sm rounded-2xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-6 shadow-xl">
          <h3 id="confirm-activo-title" class="text-lg font-semibold text-stone-800 dark:text-stone-100 mb-2">
            Confirmar cambio de estado
          </h3>
          <p class="text-sm text-stone-600 dark:text-stone-400 mb-4">
            Para {{ member.activo ? 'desactivar' : 'activar' }} a <strong>{{ member.nombre }} {{ member.apellido }}</strong>, ingresa su número de documento.
          </p>
          <label for="confirm-doc" class="sr-only">Número de documento</label>
          <input id="confirm-doc"
                 type="text"
                 [(ngModel)]="confirmActivoDocumento"
                 name="confirmActivoDocumento"
                 placeholder="Número de documento"
                 class="w-full rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-4 py-2.5 text-stone-800 dark:text-stone-200 placeholder:text-stone-400 focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 mb-3"
                 (keydown.enter)="confirmAndToggleActivo()">
          @if (confirmActivoError) {
            <p class="text-sm text-red-600 dark:text-red-400 mb-3">{{ confirmActivoError }}</p>
          }
          <div class="flex gap-3 justify-end">
            <button type="button"
                    (click)="closeConfirmActivo()"
                    [disabled]="updatingActivo"
                    class="rounded-lg border border-stone-200 dark:border-stone-600 px-4 py-2 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 disabled:opacity-50">
              Cancelar
            </button>
            <button type="button"
                    (click)="confirmAndToggleActivo()"
                    [disabled]="updatingActivo"
                    class="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700 disabled:opacity-50">
              {{ updatingActivo ? 'Guardando…' : 'Confirmar' }}
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Novedades: días en que no puede estar -->
    <section class="rounded-xl border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-800/50 p-6">
      <h2 class="text-lg font-semibold text-stone-800 dark:text-stone-100 mb-2">Novedades y disponibilidad</h2>
      <p class="text-sm text-stone-500 dark:text-stone-400 mb-4">
        Indica en qué días con servicio no podrás estar. Debes ingresar tu documento para modificar.
      </p>
      @if (!novedadCalendarVisible) {
        <button type="button"
                (click)="openNovedadModal()"
                class="rounded-lg border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-700 px-4 py-2 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-600 transition-colors">
          Agregar novedad o día sin disponibilidad
        </button>
      } @else {
        <div class="flex items-center justify-between mb-3">
          <p class="text-base text-stone-600 dark:text-stone-400">
            <span class="inline-block w-3 h-3 rounded bg-green-500 align-middle mr-1"></span> Disponible &nbsp;
            <span class="inline-block w-3 h-3 rounded bg-stone-400 dark:bg-stone-500 align-middle mr-1"></span> No disponible. Clic en un día para cambiar.
          </p>
          <button type="button"
                  (click)="closeNovedadCalendar()"
                  class="rounded-lg border border-stone-200 dark:border-stone-600 px-3 py-1.5 text-base font-medium text-stone-600 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-700">
            Ocultar calendario
          </button>
        </div>
        @if (loadingNovedades) {
          <p class="text-base text-stone-500 dark:text-stone-400 py-4 mt-4">Cargando días con servicio…</p>
        } @else if (servicios.length === 0) {
          <p class="text-base text-stone-500 dark:text-stone-400 py-4 mt-4">No hay días con servicio en los próximos 3 meses.</p>
        } @else {
          <div class="mt-7 pt-6 border-t border-stone-200 dark:border-stone-600 text-base">
            <div class="grid grid-cols-3 items-center gap-2 mb-3">
              <button type="button"
                      (click)="novedadPrevMonth()"
                      class="justify-self-start rounded border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-2.5 py-1 text-base font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 w-fit whitespace-nowrap">
                ← Anterior
              </button>
              <span class="text-center text-lg font-semibold text-stone-800 dark:text-stone-100">{{ novedadMonthLabel() }}</span>
              <button type="button"
                      (click)="novedadNextMonth()"
                      class="justify-self-end rounded border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-2.5 py-1 text-base font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 w-fit whitespace-nowrap">
                Siguiente →
              </button>
            </div>
            <div class="grid grid-cols-7 gap-0.5 text-center text-sm font-medium text-stone-500 dark:text-stone-400 mb-1">
            @for (w of weekDays; track w) {
              <span>{{ w }}</span>
            }
          </div>
          <div class="grid grid-cols-7 gap-1">
            @for (cell of novedadCalendarGrid(); track (cell.dateStr ?? 'e' + $index)) {
              @if (cell.servicio) {
                <button type="button"
                        (click)="toggleNovedad(cell.servicio)"
                        [disabled]="updatingNovedadServicioId === cell.servicio.id"
                        [attr.aria-pressed]="hasNovedadForServicio(cell.servicio.id)"
                        [attr.title]="hasNovedadForServicio(cell.servicio.id) ? 'Clic para quitar novedad' : 'Clic para marcar no disponible'"
                        class="aspect-[2/1] min-w-0 rounded-lg text-base font-medium transition-colors disabled:opacity-50
                              {{ hasNovedadForServicio(cell.servicio.id)
                                 ? 'bg-stone-400 dark:bg-stone-500 text-white hover:bg-stone-500 dark:hover:bg-stone-600'
                                 : 'bg-green-500 dark:bg-green-500 text-white hover:bg-green-600 dark:hover:bg-green-600' }}">
                  {{ cell.day }}
                </button>
              } @else if (cell.day !== null) {
                <div class="aspect-[2/1] rounded-lg bg-stone-100/50 dark:bg-stone-800/30 text-stone-400 dark:text-stone-500 text-base flex items-center justify-center" aria-hidden="true">
                  {{ cell.day }}
                </div>
              } @else {
                <div class="aspect-[2/1] rounded-lg bg-stone-50/50 dark:bg-stone-800/20" aria-hidden="true"></div>
              }
            }
          </div>
          </div>
        }
      }
    </section>

    <!-- Modal solo para verificar documento antes de mostrar el calendario -->
    @if (showNovedadModal) {
      <div class="fixed inset-0 z-50 flex items-center justify-center p-4"
           role="dialog"
           aria-modal="true"
           aria-labelledby="novedad-modal-title">
        <div class="fixed inset-0 bg-black/50" (click)="closeNovedadModal()"></div>
        <div class="relative z-10 w-full max-w-sm rounded-2xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-6 shadow-xl">
          <h3 id="novedad-modal-title" class="text-lg font-semibold text-stone-800 dark:text-stone-100 mb-2">Verificar identidad</h3>
          <p class="text-sm text-stone-600 dark:text-stone-400 mb-4">
            Para gestionar tus días sin disponibilidad, ingresa tu número de documento.
          </p>
          <label for="novedad-doc" class="sr-only">Número de documento</label>
          <input id="novedad-doc"
                 type="text"
                 [(ngModel)]="novedadDocumento"
                 name="novedadDocumento"
                 placeholder="Número de documento"
                 class="w-full rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-4 py-2.5 text-stone-800 dark:text-stone-200 placeholder:text-stone-400 focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 mb-3"
                 (keydown.enter)="confirmNovedadDocumento()">
          @if (novedadDocError) {
            <p class="text-sm text-red-600 dark:text-red-400 mb-3">{{ novedadDocError }}</p>
          }
          <div class="flex gap-3 justify-end">
            <button type="button"
                    (click)="closeNovedadModal()"
                    class="rounded-lg border border-stone-200 dark:border-stone-600 px-4 py-2 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700">
              Cancelar
            </button>
            <button type="button"
                    (click)="confirmNovedadDocumento()"
                    [disabled]="loadingNovedades"
                    class="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700 disabled:opacity-50">
              {{ loadingNovedades ? 'Cargando…' : 'Continuar' }}
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Modal motivo de la ausencia (deshabilitado: cambiar false por showMotivoForNovedad para reactivar) -->
    @if (false) {
      <div class="fixed inset-0 z-[60] flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="motivo-title">
        <div class="fixed inset-0 bg-black/50" (click)="closeMotivoModal()"></div>
        <div class="relative z-10 w-full max-w-md rounded-2xl border border-stone-200 dark:border-stone-600 bg-white dark:bg-stone-800 p-6 shadow-xl">
          <h4 id="motivo-title" class="text-lg font-semibold text-stone-800 dark:text-stone-100 mb-2">Motivo de la novedad (opcional)</h4>
          <p class="text-sm text-stone-600 dark:text-stone-400 mb-3">Indica por qué no podrás ese día, si lo deseas.</p>
          <label for="motivo-text" class="sr-only">Motivo</label>
          <textarea id="motivo-text"
                    [(ngModel)]="motivoTexto"
                    name="motivoTexto"
                    rows="3"
                    placeholder="Ej: Viaje, enfermedad, otro compromiso…"
                    class="w-full rounded-lg border border-stone-200 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/50 px-4 py-2.5 text-stone-800 dark:text-stone-200 placeholder:text-stone-400 resize-none mb-4 focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500"></textarea>
          <div class="flex gap-3 justify-end">
            <button type="button"
                    (click)="closeMotivoModal()"
                    [disabled]="savingMotivo"
                    class="rounded-lg border border-stone-200 dark:border-stone-600 px-4 py-2 text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-100 dark:hover:bg-stone-700 disabled:opacity-50">
              Omitir
            </button>
            <button type="button"
                    (click)="saveMotivo()"
                    [disabled]="savingMotivo"
                    class="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700 disabled:opacity-50">
              {{ savingMotivo ? 'Guardando…' : 'Guardar' }}
            </button>
          </div>
        </div>
      </div>
    }
  }
</div>
